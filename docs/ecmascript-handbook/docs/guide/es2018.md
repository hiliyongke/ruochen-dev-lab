# ES2018 (ES9)

ECMAScript 2018 (ES9) 带来了几项重要更新，特别是在异步处理和正则表达式方面，进一步完善了语言的能力。

## 1. 异步迭代 (Asynchronous Iteration)

ES6 引入了迭代器（Iterator）和 `for...of` 循环，用于遍历同步数据结构。ES2018 则引入了异步迭代器（Async Iterator）和 `for-await-of` 循环，用于遍历异步数据源（例如，分块读取的数据流）。

一个对象如果部署了 `Symbol.asyncIterator` 方法，那么它就是异步可迭代的。这个方法返回一个异步迭代器对象，该对象也有一个 `next()` 方法，但 `next()` 方法返回的是一个 Promise。

### `for-await-of`

`for-await-of` 循环可以自动处理异步迭代器 `next()` 方法返回的 Promise。

```javascript
// 模拟一个异步数据流
function createAsyncIterable(data) {
  return {
    [Symbol.asyncIterator]() {
      let i = 0;
      return {
        next() {
          if (i < data.length) {
            return new Promise(resolve => {
              setTimeout(() => {
                resolve({ value: data[i++], done: false });
              }, 100); // 模拟网络延迟
            });
          }
          return Promise.resolve({ done: true });
        }
      };
    }
  };
}

const asyncData = createAsyncIterable(['a', 'b', 'c']);

async function processData() {
  for await (const item of asyncData) {
    console.log(item);
  }
}

processData(); // 会依次间隔 100ms 输出 a, b, c
```

## 2. 对象的 Rest/Spread 属性

这个特性将 Rest 参数和扩展运算符（`...`）的能力从数组扩展到了对象。

### Rest 属性

在对象解构中使用，用于收集对象中未被解构的余下属性，生成一个新对象。

```javascript
const person = { name: 'Yorke', age: 30, city: 'Shanghai', country: 'China' };
const { name, ...rest } = person;

console.log(name); // 'Yorke'
console.log(rest); // { age: 30, city: 'Shanghai', country: 'China' }
```

### Spread 属性

在对象字面量中使用，用于将一个对象的自有可枚举属性“展开”并复制到新对象中。这为合并和克隆对象提供了一种极其简洁的语法（注意是浅拷贝）。

```javascript
const defaults = { theme: 'light', fontSize: 14 };
const userSettings = { fontSize: 16, showAvatar: true };

const finalSettings = { ...defaults, ...userSettings };
// { theme: 'light', fontSize: 16, showAvatar: true }
```

## 3. `Promise.prototype.finally()`

这个方法我们已在 Promise 章节中提及。它为 Promise 添加了一个 `finally` 回调，无论 Promise 最终是 `fulfilled` 还是 `rejected`，该回调都会被执行。这对于执行清理操作（如隐藏加载动画）非常有用。

```javascript
fetch('/api/data')
  .then(data => {
    // ... process data
  })
  .catch(error => {
    // ... handle error
  })
  .finally(() => {
    // ... hide loading spinner
  });
```

## 4. 正则表达式的增强

ES2018 对正则表达式进行了四项重要增强。

### s (dotAll) 标志

默认情况下，正则表达式中的点（`.`）匹配除换行符（如 `\n`）之外的任何单个字符。`s` 标志改变了这一行为，使得点（`.`）可以匹配**包括换行符在内**的任意单个字符。

```javascript
const text = 'hello\nworld';

console.log(/hello.world/.test(text));  // false
console.log(/hello.world/s.test(text)); // true
```

### 命名捕获组 (Named Capture Groups)

允许为捕获组指定一个名称，使得代码更具可读性，并且可以方便地从匹配结果中按名称提取数据。

```javascript
const dateRegex = /(?<year>\d{4})-(?<month>\d{2})-(?<day>\d{2})/;
const match = dateRegex.exec('2025-10-14');

console.log(match.groups.year);  // "2025"
console.log(match.groups.month); // "10"
console.log(match.groups.day);   // "14"
```

### 后行断言 (Lookbehind Assertions)

正则表达式已支持先行断言（Lookahead），ES2018 引入了后行断言（Lookbehind），包括：
-   **肯定后行断言** `(?<=...)`: 匹配前面是 `...` 的位置。
-   **否定后行断言** `(?<!...)`: 匹配前面不是 `...` 的位置。

```javascript
// 匹配美元金额，但不包括美元符号
const usdRegex = /(?<=\$)\d+(\.\d*)?/;
console.log('Price: $19.99'.match(usdRegex)[0]); // "19.99"

// 匹配前面不是数字的 "px"
const pxRegex = /(?<!\d)px/;
console.log('12px'.match(pxRegex)); // null
console.log('font-size: 12px'.match(pxRegex)); // ["px", index: 15, ...]
```

### Unicode 属性转义 (`\p{...}` 和 `\P{...}`)

允许在正则表达式中通过 Unicode 属性来匹配字符，例如匹配所有希腊字母、所有标点符号等。需要设置 `u` 标志。

```javascript
const greekLetter = /\p{Script=Greek}/u;
console.log(greekLetter.test('π')); // true

const notNumber = /\P{Number}/u;
console.log(notNumber.test('1')); // false
console.log(notNumber.test('a')); // true