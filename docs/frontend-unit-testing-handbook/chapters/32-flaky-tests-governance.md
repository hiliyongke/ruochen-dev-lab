# Flaky 测试治理与稳定性工程

目标：系统性减少不稳定用例（Flaky），让测试在 CI/本地稳定通过并具备可观测性。

成因分类：
- 时间与异步：未等待稳定时机、竞态条件、未关闭定时器
- 网络与环境：真实依赖波动、外部服务限流
- 渲染与动画：过渡/动画导致非确定性
- 随机与种子：伪随机未固定

治理策略：
- 稳定化依赖：统一 fake timers、固定随机种子（faker.seed）、MSW 拦截网络
- 明确等待点：使用 waitFor/waitUntil，避免硬编码 setTimeout
- 竞态防护：AbortController/“alive”标记；卸载时清理订阅与副作用
- 动画关闭：prefers-reduced-motion 或测试配置关闭动画

度量与可观测：
- 记录失败用例指纹（文件/测试名/错误栈）并按频次排行
- 输出波动报告到 PR，要求治理完成后再合并

重试与隔离：
- 重试仅作为兜底（Playwright/Jest 重试），优先修因
- 将不稳定用例单独标记，CI 分层运行并输出单独报告

实践清单（Checklist）
- [ ] 固定随机种子与 fake timers
- [ ] MSW 拦截外部网络，消除环境依赖
- [ ] 明确等待点与竞态防护
- [ ] 动画与过渡在测试中关闭

常见排查
- 偶发失败：优先检查等待时机与竞态；引入日志/标记定位
- 环境波动：确认是否存在真实外部依赖，改为 Mock